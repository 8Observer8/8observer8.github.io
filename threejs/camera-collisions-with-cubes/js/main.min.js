var camera,scene,renderer,controls,stats;var objects=[];var raycaster;var blocker=document.getElementById("blocker");var instructions=document.getElementById("instructions");var havePointerLock="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;if(havePointerLock){var element=document.body;var pointerlockchange=function(event){if(document.pointerLockElement===element||document.mozPointerLockElement===element||document.webkitPointerLockElement===element){controlsEnabled=true;controls.enabled=true;blocker.style.display="none"}else{controls.enabled=false;blocker.style.display="block";instructions.style.display=""}};var pointerlockerror=function(event){instructions.style.display=""};document.addEventListener("pointerlockchange",pointerlockchange,false);document.addEventListener("mozpointerlockchange",pointerlockchange,false);document.addEventListener("webkitpointerlockchange",pointerlockchange,false);document.addEventListener("pointerlockerror",pointerlockerror,false);document.addEventListener("mozpointerlockerror",pointerlockerror,false);document.addEventListener("webkitpointerlockerror",pointerlockerror,false);instructions.addEventListener("click",function(event){instructions.style.display="none";element.requestPointerLock=element.requestPointerLock||element.mozRequestPointerLock||element.webkitRequestPointerLock;element.requestPointerLock()},false)}else{instructions.innerHTML="Your browser doesn't seem to support Pointer Lock API"}init();animate();var controlsEnabled=false;var moveForward=false;var moveBackward=false;var moveLeft=false;var moveRight=false;var canJump=false;var prevTime=performance.now();var velocity=new THREE.Vector3;var direction=new THREE.Vector3;function init(){camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1e3);scene=new THREE.Scene;scene.background=new THREE.Color(16777215);scene.fog=new THREE.Fog(16777215,0,750);stats=new Stats;document.body.appendChild(stats.domElement);var light=new THREE.HemisphereLight(15658751,7829384,.75);light.position.set(.5,1,.75);scene.add(light);controls=new THREE.PointerLockControls(camera);scene.add(controls.getObject());var onKeyDown=function(event){switch(event.keyCode){case 38:case 87:moveForward=true;break;case 37:case 65:moveLeft=true;break;case 40:case 83:moveBackward=true;break;case 39:case 68:moveRight=true;break;case 32:if(canJump===true)velocity.y+=350;canJump=false;break}};var onKeyUp=function(event){switch(event.keyCode){case 38:case 87:moveForward=false;break;case 37:case 65:moveLeft=false;break;case 40:case 83:moveBackward=false;break;case 39:case 68:moveRight=false;break}};document.addEventListener("keydown",onKeyDown,false);document.addEventListener("keyup",onKeyUp,false);raycaster=new THREE.Raycaster(new THREE.Vector3,new THREE.Vector3(0,-1,0),0,10);var floorGeometry=new THREE.PlaneGeometry(2e3,2e3,100,100);floorGeometry.rotateX(-Math.PI/2);for(var i=0,l=floorGeometry.vertices.length;i<l;i++){var vertex=floorGeometry.vertices[i];vertex.x+=Math.random()*20-10;vertex.y+=Math.random()*2;vertex.z+=Math.random()*20-10}for(var i=0,l=floorGeometry.faces.length;i<l;i++){var face=floorGeometry.faces[i];face.vertexColors[0]=(new THREE.Color).setHSL(Math.random()*.3+.5,.75,Math.random()*.25+.75);face.vertexColors[1]=(new THREE.Color).setHSL(Math.random()*.3+.5,.75,Math.random()*.25+.75);face.vertexColors[2]=(new THREE.Color).setHSL(Math.random()*.3+.5,.75,Math.random()*.25+.75)}var floorMaterial=new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors});var floor=new THREE.Mesh(floorGeometry,floorMaterial);scene.add(floor);var boxGeometry=new THREE.BoxGeometry(20,20,20);for(var i=0,l=boxGeometry.faces.length;i<l;i++){var face=boxGeometry.faces[i];face.vertexColors[0]=(new THREE.Color).setHSL(Math.random()*.3+.5,.75,Math.random()*.25+.75);face.vertexColors[1]=(new THREE.Color).setHSL(Math.random()*.3+.5,.75,Math.random()*.25+.75);face.vertexColors[2]=(new THREE.Color).setHSL(Math.random()*.3+.5,.75,Math.random()*.25+.75)}for(var i=0;i<100;i++){var boxMaterial=new THREE.MeshPhongMaterial({specular:16777215,flatShading:true,vertexColors:THREE.VertexColors});boxMaterial.color.setHSL(Math.random()*.2+.5,.75,Math.random()*.25+.75);var box=new THREE.Mesh(boxGeometry,boxMaterial);box.position.x=Math.floor(Math.random()*20-10)*20;box.position.y=10;box.position.z=Math.floor(Math.random()*20-10)*20;scene.add(box);objects.push(box)}renderer=new THREE.WebGLRenderer;renderer.setPixelRatio(window.devicePixelRatio);renderer.setSize(window.innerWidth,window.innerHeight);document.body.appendChild(renderer.domElement);window.addEventListener("resize",onWindowResize,false)}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)}function animate(){stats.update();requestAnimationFrame(animate);if(controlsEnabled===true){raycaster.ray.origin.copy(controls.getObject().position);raycaster.ray.origin.y-=10;var intersections=raycaster.intersectObjects(objects);var onObject=intersections.length>0;var time=performance.now();var delta=(time-prevTime)/1e3;velocity.x-=velocity.x*10*delta;velocity.z-=velocity.z*10*delta;velocity.y-=9.8*100*delta;direction.z=Number(moveForward)-Number(moveBackward);direction.x=Number(moveLeft)-Number(moveRight);direction.normalize();if(moveForward||moveBackward)velocity.z-=direction.z*400*delta;if(moveLeft||moveRight)velocity.x-=direction.x*400*delta;if(onObject===true){velocity.y=Math.max(0,velocity.y);canJump=true}controls.getObject().translateX(velocity.x*delta);controls.getObject().translateY(velocity.y*delta);controls.getObject().translateZ(velocity.z*delta);if(controls.getObject().position.y<10){velocity.y=0;controls.getObject().position.y=10;canJump=true}prevTime=time}renderer.render(scene,camera)}