import{Display,Game,AUTO}from"phaser3";import Box2DLib from"box2d-wasm";let box2d=null;function initBox2D(localhost=true){return new Promise(resolve=>{Box2DLib().then(re=>{box2d=re;resolve()})})}class ContactListener{constructor(metaData){this.metaData=metaData;const{b2Contact,getPointer,JSContactListener,wrapPointer}=box2d;const self=this;this.instance=Object.assign(new JSContactListener,{BeginContact(contact){contact=wrapPointer(contact,b2Contact);const fixtureA=contact.GetFixtureA();const fixtureB=contact.GetFixtureB();const nameA=self.metaData[getPointer(fixtureA)].name;const nameB=self.metaData[getPointer(fixtureB)].name;console.log(`"${nameA}" <-> "${nameB}"`)},EndContact(contact){},PreSolve(contact){},PostSolve(contact){}})}}const sizeOfB2Vec2=Float32Array.BYTES_PER_ELEMENT*2;class DebugDrawer{constructor(graphics,pixelsPerMeter){this.graphics=graphics;this.pixelsPerMeter=pixelsPerMeter;const{b2Color,b2Draw:{e_shapeBit},b2Vec2,JSDraw,wrapPointer}=box2d;const reifyArray=(array_p,numElements,sizeOfElement,ctor)=>Array(numElements).fill(undefined).map((_,index)=>wrapPointer(array_p+index*sizeOfElement,ctor));self=this;const debugDrawer=Object.assign(new JSDraw,{DrawSegment(vert1_p,vert2_p,color_p){},DrawPolygon(vertices_p,vertexCount,color_p){},DrawSolidPolygon(vertices_p,vertexCount,color_p){const color=wrapPointer(color_p,b2Color);const vertices=reifyArray(vertices_p,vertexCount,sizeOfB2Vec2,b2Vec2);self.drawLines(vertices,color)},DrawCircle(center_p,radius,color_p){},DrawSolidCircle(center_p,radius,axis_p,color_p){const center=wrapPointer(center_p,b2Vec2);const color=wrapPointer(color_p,b2Color);self.drawCircle(center.x*self.pixelsPerMeter,center.y*self.pixelsPerMeter,radius*self.pixelsPerMeter,color)},DrawTransform(transform_p){},DrawPoint(vertex_p,sizeMetres,color_p){}});debugDrawer.SetFlags(e_shapeBit);this.instance=debugDrawer}drawLines(vertices,color){const c=(new Display.Color).setGLTo(color.r,color.g,color.b,1);this.graphics.lineStyle(3,c.color,1);this.graphics.beginPath();this.graphics.moveTo(vertices[0].x*this.pixelsPerMeter,vertices[0].y*this.pixelsPerMeter);this.graphics.lineTo(vertices[1].x*this.pixelsPerMeter,vertices[1].y*this.pixelsPerMeter);this.graphics.lineTo(vertices[2].x*this.pixelsPerMeter,vertices[2].y*this.pixelsPerMeter);this.graphics.lineTo(vertices[3].x*this.pixelsPerMeter,vertices[3].y*this.pixelsPerMeter);this.graphics.lineTo(vertices[0].x*this.pixelsPerMeter,vertices[0].y*this.pixelsPerMeter);this.graphics.closePath();this.graphics.strokePath()}drawCircle(x0,y0,radius,color){let angle=0;const angleStep=20;const n=360/angleStep;const c=(new Display.Color).setGLTo(color.r,color.g,color.b,1);this.graphics.lineStyle(3,c.color,1);this.graphics.beginPath();let x=radius*Math.cos(angle*Math.PI/180);let y=radius*Math.sin(angle*Math.PI/180);this.graphics.moveTo(x0+x,y0+y);angle+=angleStep;for(let i=0;i<n;i++){x=radius*Math.cos(angle*Math.PI/180);y=radius*Math.sin(angle*Math.PI/180);this.graphics.lineTo(x0+x,y0+y);angle+=angleStep}this.graphics.closePath();this.graphics.strokePath()}clear(){setTimeout(()=>this.graphics.clear(),0)}}const config={type:AUTO,parent:"phaser-example",width:300,height:300,scene:{create:create,update:update}};new Game(config);async function create(){await initBox2D();const{b2_dynamicBody,b2BodyDef,b2CircleShape,b2PolygonShape,b2Vec2,b2World,getPointer}=box2d;this.world=new b2World;const gravity=new b2Vec2(0,9.8);this.world.SetGravity(gravity);this.pixelsPerMeter=30;this.graphics=this.add.graphics();this.debugDrawer=new DebugDrawer(this.graphics,this.pixelsPerMeter);this.world.SetDebugDraw(this.debugDrawer.instance);const metaData={};const groundBodyDef=new b2BodyDef;groundBodyDef.set_position(new b2Vec2(150/this.pixelsPerMeter,285/this.pixelsPerMeter));const groundBody=this.world.CreateBody(groundBodyDef);const groundShape=new b2PolygonShape;groundShape.SetAsBox(270/2/this.pixelsPerMeter,15/2/this.pixelsPerMeter);const groundFixture=groundBody.CreateFixture(groundShape,0);metaData[getPointer(groundFixture)]={name:"ground"};const boxBodyDef=new b2BodyDef;boxBodyDef.set_position(new b2Vec2(150/this.pixelsPerMeter,0/this.pixelsPerMeter));boxBodyDef.angle=-20*Math.PI/180;boxBodyDef.type=b2_dynamicBody;const boxBody=this.world.CreateBody(boxBodyDef);const boxShape=new b2PolygonShape;boxShape.SetAsBox(60/2/this.pixelsPerMeter,60/2/this.pixelsPerMeter);const boxFixture=boxBody.CreateFixture(boxShape,1);metaData[getPointer(boxFixture)]={name:"box"};const circleBodyDef=new b2BodyDef;circleBodyDef.position=new b2Vec2(50/this.pixelsPerMeter,230/this.pixelsPerMeter);const circleRigidBody=this.world.CreateBody(circleBodyDef);const circleShape=new b2CircleShape;circleShape.m_radius=20/this.pixelsPerMeter;const circleFixture=circleRigidBody.CreateFixture(circleShape,0);metaData[getPointer(circleFixture)]={name:"circle"};const platformBodyDef=new b2BodyDef;platformBodyDef.set_position(new b2Vec2(225/this.pixelsPerMeter,195/this.pixelsPerMeter));platformBodyDef.angle=0*Math.PI/180;const platformBody=this.world.CreateBody(platformBodyDef);const platformShape=new b2PolygonShape;platformShape.SetAsBox(120/2/this.pixelsPerMeter,15/2/this.pixelsPerMeter);const platformFixture=platformBody.CreateFixture(platformShape,0);metaData[getPointer(platformFixture)]={name:"platform"};const contactListener=new ContactListener(metaData);this.world.SetContactListener(contactListener.instance);this.currentTime=0;this.dt=0;this.lastTime=Date.now()}function update(){if(!this.world){return}this.currentTime=Date.now();this.dt=(this.currentTime-this.lastTime)/1e3;this.lastTime=this.currentTime;this.world.Step(this.dt,3,2);this.world.DebugDraw();this.debugDrawer.clear()}